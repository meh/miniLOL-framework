/* miniLOL is released under AGPLv3. Copyleft meh. [http://meh.doesntexist.org | meh.ffff@gmail.com] */
if(navigator.userAgent.match(/Chrome/))Prototype.Browser.Chrome=true;if(navigator.userAgent.match(/Safari/)&&!Prototype.Browser.Chrome)Prototype.Browser.Safari=true;if(Prototype.Browser.Gecko||Prototype.Browser.Opera)Prototype.Browser.Good=true;else Prototype.Browser.Bad=true;
if(Prototype.Browser.IE)Error.prototype.toString=function(){return"#{name}: #{description}<br/><br/>#{stack}".interpolate({name:this.name,description:this.description,stack:(this.stack||"").replace(/\n/g,"<br/>")})};else if(Prototype.Browser.Opera)Error.prototype.toString=function(){return"#{name}: #{message}".interpolate(this)};else if(Prototype.Browser.Gecko)Error.prototype.toString=function(){return"#{name}: #{message}<br/><br/>#{stack}".interpolate({name:this.name,message:this.message,stack:this.stack.replace(/\n/g,
"<br/>")})};else if(Prototype.Browser.Chrome||Prototype.Browser.Safari)Error.prototype.toString=function(){return"#{name}: #{message}<br/><br/>#{stack}".interpolate({name:this.name,message:this.message,stack:this.stack.replace(/\n/g,"<br/>")})};if(Prototype.Browser.IE){if(!window.DOMParser)window.DOMParser=Class.create({parseFromString:function(a){var b=new AciveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);return b}});if(!window.XMLSerializer)window.XMLSerializer=Class.create({serializeToString:function(a){return a.xml}})}
Object.extend(Function,{parse:function(a){matches=a.match(/^function\s*\((.*?)\)[\s\n]*\{([\s\S]*)\}[\s\n]*/m);if(!matches)return null;a=matches[1].split(/\s*,\s*/);return new Function(a,matches[2])}});Object.extend(Function.prototype,{clone:function(){return Function.parse(this.toString())}});
Object.extend(Object,{isBoolean:function(a){return a.constructor===Boolean},isObject:function(a){return typeof a=="object"},isDocument:function(a){return a.toString().include("Document")},isXML:function(a){if(typeof a!=="object")return false;a=a.ownerDocument||a;if(!a.documentElement)return false;return a.documentElement.nodeName!="HTML"},fromAttributes:function(a){for(var b={},c=0;c<a.length;c++)b[a.item(c).nodeName]=a.item(c).nodeName;return b},toQueryString:function(a){var b="",c;for(c in a)b+=
"#{name}=#{value}&".interpolate({name:c,value:a[c]});return b.substr(0,b.length-1)}});if(!Object.isFunction(Object.defineProperty))Object.defineProperty=function(a,b,c){Object.isFunction(c.get)&&Object.isFunction(a.__defineGetter__)&&a.__defineGetter__(b,c.get);Object.isFunction(c.set)&&Object.isFunction(a.__defineSetter__)&&a.__defineSetter__(b,c.set)};if(!Object.isFunction(Object.defineProperties))Object.defineProperties=function(a,b){for(var c in b)Object.defineProperty(a,c,b[c])};
if(!Object.isFunction(Object.create))Object.create=function(a,b){var c=Object(a);Object.defineProperties(c,b);return c};Object.extend(String,{fromAttributes:function(a){for(var b="",c=0;c<a.length;c++)b+='#{name}="#{value}" '.interpolate({name:a.item(c).nodeName,value:a.item(c).nodeValue});return b},fromXML:function(a){if(!Object.isXML(a))return false;return(new XMLSerializer).serializeToString(a)}});
Object.extend(String.prototype,{toQueryParams:function(){var a={},b=this.match(/[?#](.*)$/);if(!b)return a;b=b[1].split(/&/);for(var c=0;c<b.length;c++){var d=b[c].split(/=/),e=decodeURIComponent(d[0]);a[e]=d[1]?decodeURIComponent(d[1]):true}return a},toXML:function(){return(new DOMParser).parseFromString(this,"text/xml")},isEmpty:function(){return this==0},isURL:function(){var a=this.match(/^mailto:([\w.%+-]+@[\w.]+\.[A-Za-z]{2,4})$/);if(a)return{protocol:"mailto",uri:a[1]};a=this.match(/^(\w+):(\/\/.+?(:\d)?)(\/)?/);
if(!a)return false;return{protocol:a[1],uri:a[2]}},getHashFragment:function(){var a=this.match(/(#.*)$/);return a?a[1]:""}});
Element.addMethods({load:function(a,b){if(b&&!Object.isUndefined(b.frequency))new Ajax.PeriodicalUpdater(this,a,b);else new Ajax.Updater(this,a,b)},xpath:function(a,b){a=Object.isElement(a)||Object.isDocument(a)?a:this;b=Object.isElement(a)||Object.isDocument(a)?b:a;return miniLOL.utils.XML.xpath.call(a,b)},select:function(a,b){a=Object.isElement(a)||Object.isDocument(a)?a:this;b=Object.isElement(a)||Object.isDocument(a)?b:a;return miniLOL.utils.XML.select.call(a,b)},getTextDescendants:function(a){function b(d){for(d=
d.firstChild;d;){Node.TEXT_NODE==d.nodeType&&c.push(d);Object.isElement(d)&&b(d);d=d.nextSibling}}a=a||this;var c=[];b(a);return c},toObject:function(a){a=a||this;var b={};if(!Object.isElement(a)&&!Object.isDocument(a))return b;$A(a.childNodes).each(function(c){if(c.nodeType==Node.ELEMENT_NODE)if(c.getElementsByTagName("*").length==0){var d="";$A(c.childNodes).each(function(e){e.nodeType!=Node.CDATA_SECTION_NODE&&e.nodeType!=Node.TEXT_NODE||e.nodeValue.isEmpty()||(d+=e.nodeValue)});b[c.nodeName]=
d}else b[c.nodeName]=Element.toObject(c)});return b}});if(!Object.isObject(window.miniLOL))window.miniLOL={error:Prototype.emptyFunction};
miniLOL.History={interval:0.2,initialize:function(){miniLOL.History.current=window.location.hash;Event.observe(window,"hashchange",function(a){miniLOL.History.current=a.memo=a.memo||window.location.hash.replace(/^#/,"")});miniLOL.History.Initializers.get().call()},reset:function(a,b){if(Object.isNumber(a))miniLOL.History.interval=a;Object.isUndefined(miniLOL.History.timer)||clearInterval(miniLOL.History.timer);miniLOL.History.timer=setInterval(b,miniLOL.History.interval*1E3)},Initializers:{get:function(){return"onhashchange"in
window&&!navigator.userAgent.include("MSIE 7")?miniLOL.History.Initializers.Default:miniLOL.History.Initializers.Unsupported},Default:Prototype.emptyFunction,Unsupported:function(){miniLOL.History.reset(miniLOL.History.interval,miniLOL.History.Checkers.get())}},Checkers:{get:function(){return Prototype.Browser.IE?miniLOL.History.Checkers.InternetExplorer:miniLOL.History.Checkers.Default},Default:function(){miniLOL.History.current!=window.location.hash&&Event.fire(window,"hashchange",window.location.hash.replace(/^#/,
""))},InternetExplorer:function(){}}};miniLOL.History.initialize();
miniLOL.Resource=Class.create({initialize:function(a,b){if(!b)throw Error("No wrapper has been passed.");this.name=a;this.wrapper=b;if(!this.wrapper.clear)this.wrapper.clear=function(){this.data={}};for(var c in this.wrapper){if(Object.isFunction(this.wrapper[c])){if(this.wrapper[c].parent==this.wrapper)break;this.wrapper[c]=this.wrapper[c].bind(this.wrapper);this.wrapper[c].parent=this.wrapper}if(Object.isUndefined(this[c]))this[c]=this.wrapper[c]}this.clear();this.flush();this.wrapper.initialize&&
this.wrapper.initialize()},load:function(){var a,b=$A(arguments);Event.fire(document,":resource.load",{resource:this,arguments:b});this.calls.push(b);try{a=this.wrapper.load.apply(this.wrapper,b)}catch(c){miniLOL.error("Error while loading `#{name}` resource.\n#{error}".interpolate({name:this.name,error:c.toString()}));return false}Event.fire(document,":resource.loaded",{resource:this,arguments:b});return a},reload:function(){Event.fire(document,":resource.reload",{resource:this});this.wrapper.clear();
this.flush().each(function(a){this.load.apply(this,a)},this);Event.fire(document,":resource.reloaded",{resource:this})},clear:function(){Event.fire(document,":resource.clear",{resource:this});this.wrapper.clear()},flush:function(a){Event.fire(document,":resource.flush",{resource:this,call:a});var b;if(Object.isArray(a)){if(b=this.calls.find(function(c){if(c.length!=a.length)return false;for(var d=false,e=0;e<c.length;e++){if(a[e]==c[e])d=true;if(!d)break}return d}))this.calls=this.calls.filter(function(c){return c!=
b})}else{b=this.calls;this.calls=[]}return b},data:function(){return this.wrapper.data}});
miniLOL.JSON=Class.create({initialize:function(a){this.replace(a)},get:function(a){return this.data[a]},set:function(a,b){return this.data[a]=b},remove:function(a){var b=this.data[a];delete this.data[a];return b},clear:function(){var a=this.data;this.data={};return a},replace:function(a){var b=this.data;this.data=Object.isString(a)?miniLOL.JSON.unserialize(a):Object.extend({},a);return b},toString:function(){return miniLOL.JSON.serialize(this.data)||"{}"}});miniLOL.JSON.parse=function(a){return new miniLOL.JSON(a)};
miniLOL.JSON.serializeSpecial=function(a){if(typeof a!=="object")return a;a=Object.clone(a);for(var b in a)a[b]=Object.isXML(a[b])?{__miniLOL_is_xml:true,value:String.fromXML(a[b])}:Object.isFunction(a[b])?{__miniLOL_is_function:true,value:a[b].toString()}:miniLOL.JSON.serializeSpecial(a[b]);return a};
miniLOL.JSON.unserializeSpecial=function(a){if(typeof a!=="object")return a;a=Object.clone(a);for(var b in a)a[b]=a[b].__miniLOL_is_xml?a[b].value.toXML():a[b].__miniLOL_is_function?Function.parse(a[b].value):miniLOL.JSON.unserializeSpecial(a[b]);return a};miniLOL.JSON.serialize=function(a){try{return Object.toJSON(miniLOL.JSON.serializeSpecial(a))}catch(b){return false}};miniLOL.JSON.unserialize=function(a){if(!Object.isString(a))return null;try{return miniLOL.JSON.unserializeSpecial(a.evalJSON())}catch(b){return null}};
miniLOL.Cookie={get:function(a,b){b=miniLOL.Cookie.options(b);var c=window.document.cookie.match(RegExp.escape(encodeURIComponent(a))+"=([^;]*)","g");if(c){var d=[];$A(c).each(function(e){e=decodeURIComponent(e.match(/^.*?=(.*)$/)[1]);d.push(b.raw?e:miniLOL.JSON.unserialize(e)||e)});if(d.length==1)d=d[0];return d}},set:function(a,b,c){c=miniLOL.Cookie.options(c);c.raw||(b=miniLOL.JSON.serialize(b)||b);window.document.cookie=miniLOL.Cookie.encode(a,b,c)},remove:function(a,b){window.document.cookie=
miniLOL.Cookie.encode(a,"",Object.extend(miniLOL.Cookie.options(b),{expires:new Date(0)}))},clear:function(){miniLOL.Cookie.keys().each(function(a){miniLOL.Cookie.remove(a)})},keys:function(){var a=[];$A(window.document.cookie.split(/; /)).each(function(b){b=b.split(/=/);b[1]&&a.push(b[0])});return a.uniq()},encode:function(a,b,c){return"#{key}=#{value}; #{maxAge}#{expires}#{path}#{domain}#{secure}".interpolate({key:encodeURIComponent(a),value:encodeURIComponent(b),maxAge:!Object.isUndefined(c.maxAge)?
"max-age=#{0}; ".interpolate([c.maxAge]):"",expires:!Object.isUndefined(c.expires)?"expires=#{0}; ".interpolate([c.expires.toUTCString()]):"",path:!Object.isUndefined(c.path)?"path=#{0}; ".interpolate([c.path]):"",domain:!Object.isUndefined(c.domain)?"domain=#{0}; ".interpolate([c.domain]):"",secure:c.secure?"secure":""})},options:function(a){return Object.extend({expires:new Date((new Date).getTime()+36E5),path:"",domain:"",secure:"",raw:false},a||{})}};
miniLOL.Storage=Class.create({initialize:function(a,b){this.name=a;this.backend=new (b||miniLOL.Storage.Backends.available())(a)},get:function(a){return this.backend.get(a.toString())},set:function(a,b,c){return this.backend.set(a.toString(),b,c)},remove:function(a,b){return this.backend.remove(a.toString(),b)},clear:function(a){return this.backend.clear(a)},size:function(){return this.backend.size},save:function(){this.backend.save()}});
miniLOL.Storage.Backend=Class.create(miniLOL.JSON,{initialize:function($super,b,c){$super(c);this.name=miniLOL.Storage.Backend.filter(b);if(Object.isString(c))this.size=c.size},get:function($super,b){return $super(b)},set:function($super,b,c,d){b=$super(b,c);d||this.save();return b},remove:function($super,b,c){b=$super(b);c||this.save();return b},clear:function($super,b){var c=$super();b||this.save();return c},replace:function($super,b){this.size=Object.isString(b)?b.length:0;return $super(b)}});
Object.extend(miniLOL.Storage.Backend,{filter:function(a){return a.replace(/\s/g,"")}});
miniLOL.Storage.Backends={available:function(){try{return window.localStorage?miniLOL.Storage.Backends.LocalStorage:window.globalStorage?miniLOL.Storage.Backends.GlobalStorage:document.body.addBehavior?miniLOL.Storage.Backends.UserDataBehavior:miniLOL.Storage.Backends.Cookie}catch(a){return miniLOL.Storage.Backends.Null}},LocalStorage:Class.create(miniLOL.Storage.Backend,{initialize:function($super,b){$super(b);this.replace(window.localStorage["__miniLOL.storage."+this.name]||"{}")},save:function(){var a=
this.toString();this.size=a.length;window.localStorage["__miniLOL.storage."+this.name]=a}}),GlobalStorage:Class.create(miniLOL.Storage.Backend,{initialize:function($super,b){$super(b);this.replace(window.globalStorage[window.location.hostname]["__miniLOL.storage."+this.name]||"{}")},save:function(){var a=this.toString();this.size=a.length;window.globalStorage[window.location.hostname]["__miniLOL.storage."+this.name]=a}}),UserDataBehavior:Class.create(miniLOL.Storage.Backend,{initialize:function($super,
b){$super(b);this.element=document.createElement("link");this.element.addBehavior("#default#userData");$$("head")[0].appendChild(this.element);this.element.load("__miniLOL.storage."+b);var c=this.element.getAttribute("__miniLOL.storage."+this.name)||"{}";this.size=c.length;this.replace(c)},save:function(){var a=this.toString();this.size=a.length;this.element.setAttribute("__miniLOL.storage."+this.name,a);this.element.save("__miniLOL.storage."+this.name)}}),Cookie:Class.create(miniLOL.Storage.Backend,
{initialize:function($super,b){$super(b);this.replace(miniLOL.Cookie.get("__miniLOL.storage."+this.name,{raw:true})||"{}")},save:function(){var a=this.toString();this.size=a.length;miniLOL.Cookie.set("__miniLOL.storage."+this.name,a,{expires:31536E3,raw:true})}}),Null:Class.create(miniLOL.Storage.Backend,{save:Prototype.emptyFunction})};
